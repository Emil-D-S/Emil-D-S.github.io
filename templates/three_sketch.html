<!DOCTYPE html>
<html lang="en" style="width: min-content">
  <head>
    <meta charset="utf-8" />
    <title>Three.js Project Loader</title>

    <!-- <script>
      (function breakWhenBodyIsCentered() {
        const hit = () => {
          const s = getComputedStyle(document.body);
          if (
            document.body.hasAttribute("inject_vt_svd") ||
            s.display === "flex" ||
            s.justifyContent === "center" ||
            s.alignItems === "center" ||
            s.height === "100vh"
          ) {
            debugger; // <-- DevTools will stop here
          }
        };

        // run ASAP and on any DOM/style change
        const runSoon = () =>
          requestAnimationFrame(() => requestAnimationFrame(hit));
        document.addEventListener("DOMContentLoaded", runSoon, { once: true });
        runSoon();

        new MutationObserver(runSoon).observe(document.documentElement, {
          attributes: true,
          subtree: true,
          attributeFilter: ["style", "class", "inject_vt_svd"],
        });
      })();
    </script> -->

    <!-- optional importmap for module-based projects that import "three" -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
          "three/": "https://unpkg.com/three@0.161.0/"
        }
      }
    </script>

    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        overflow: hidden;
      }
      /* Optional: make any canvas naturally fill if the sketch sets it that way */
      canvas {
        display: block;
      }
    </style>
  </head>

  <body>
    <script type="module">
      const DATA_URL = new URL("../projects/data.json", import.meta.url).href;

      const params = new URLSearchParams(window.location.search);
      let folder = params.get("folder") || "";
      folder = decodeURIComponent(folder).replace(/^\/+/, "");
      if (!folder) {
        document.body.innerHTML =
          "<p style='color:#f88;padding:1rem'>Error: folder not specified</p>";
        throw new Error("No folder specified");
      }

      function log(...a) {
        console.log("[three_loader]", ...a);
      }
      function fail(msg) {
        console.error("[three_loader]", msg);
        document.body.insertAdjacentHTML(
          "beforeend",
          `<p style="color:#f88;padding:1rem">${msg}</p>`
        );
      }

      async function readFiles() {
        let files = [{ name: "sketch.js", type: "nomodule" }];

        try {
          const res = await fetch(DATA_URL);
          if (!res.ok) throw new Error("data.json fetch failed: " + res.status);
          const list = await res.json();

          let proj = null;
          if (Array.isArray(list)) {
            proj = list.find((p) => p.folder === folder);
          } else if (typeof list === "object" && list !== null) {
            if (list[folder]) proj = list[folder];
            else {
              for (const k of Object.keys(list)) {
                if (list[k] && list[k].folder === folder) {
                  proj = list[k];
                  break;
                }
              }
            }
          }

          if (proj && Array.isArray(proj.files) && proj.files.length) {
            files = proj.files
              .map((f) => {
                if (typeof f === "string") return { name: f, type: "nomodule" };
                if (f && typeof f === "object") {
                  const name = f.name || f.file || f.src;
                  const type = (f.type || "nomodule").toLowerCase();
                  return {
                    name,
                    type: type === "module" ? "module" : "nomodule",
                  };
                }
                return null;
              })
              .filter(Boolean);
          } else {
            log(
              "No project entry in data.json; using default:",
              files.map((f) => f.name)
            );
          }
        } catch (e) {
          console.warn(
            "[three_loader] couldn't read data.json; using defaults",
            e
          );
        }
        return files;
      }

      function appendScript(srcHref, type = "nomodule") {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.defer = true;
          script.onerror = () => reject(new Error("Failed to load " + srcHref));
          script.onload = () => resolve(srcHref);
          script.src = new URL(srcHref, import.meta.url).href;
          if (type === "module") script.type = "module";
          document.body.appendChild(script);
        });
      }

      async function loadAll() {
        const fileList = await readFiles();
        const toLoad = fileList.map((f) => ({
          href: `../${folder}/${f.name.replace(/^\/+/, "")}`,
          type: f.type,
        }));

        try {
          for (const f of toLoad) {
            log("Loading", f.href, "as", f.type);
            await appendScript(f.href, f.type);
          }
          log("All project files loaded.");
        } catch (e) {
          fail("Failed to load project files: " + e.message);
          console.error(e);
        }
      }

      loadAll();
    </script>
  </body>
</html>
