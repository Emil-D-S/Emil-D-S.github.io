<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>p5.js Project Loader</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- p5.js â€“ local copy, libs is parallel to templates -->
    <script src="../libs/p5.min.js"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        /* no background color here */
      }
      canvas {
        display: block; /* top-left, no auto-centering */
        /* no margins, no max-width, no color */
      }
    </style>
  </head>
  <body>
    <script type="module">
      function appendScript(src, isModule) {
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          if (isModule) s.type = "module";
          s.onload = () => resolve();
          s.onerror = (e) => reject(e);
          document.body.appendChild(s);
        });
      }

      function postCanvasSize(canvas) {
        const rect = canvas.getBoundingClientRect();
        const payload = {
          type: "canvas-size",
          width: rect.width,
          height: rect.height,
        };
        window.parent?.postMessage(payload, "*");
        window.parent?.postMessage(
          { type: "p5_canvas_size", width: rect.width, height: rect.height },
          "*"
        );
      }

      function reportCanvasSize() {
        const canvas = document.querySelector("canvas");
        if (!canvas) return;
        postCanvasSize(canvas);
      }

      (async () => {
        const params = new URLSearchParams(window.location.search);
        const folder = params.get("folder") || "";

        if (!folder) return;

        // p5 runtime check
        if (typeof window.p5 !== "function") {
          console.error("p5.js not loaded (check ../libs/p5.min.js)");
          return;
        }

        // load sketch.js from folder
        const normalizedFolder = folder.replace(/^\/+/, "");
        const sketchPath = `../${normalizedFolder}/sketch.js`;

        try {
          await appendScript(sketchPath, false);
        } catch (e) {
          console.error("Failed to load sketch.js:", e);
          return;
        }

        // give p5 a moment to create canvas, then report size
        setTimeout(reportCanvasSize, 50);

        const ro = new ResizeObserver(() => reportCanvasSize());
        const mo = new MutationObserver(() => {
          const c = document.querySelector("canvas");
          if (c) ro.observe(c);
        });
        mo.observe(document.body, { childList: true, subtree: true });

        const initialCanvas = document.querySelector("canvas");
        if (initialCanvas) ro.observe(initialCanvas);
      })().catch((err) => {
        console.error("Loader error:", err);
      });
    </script>
  </body>
</html>
